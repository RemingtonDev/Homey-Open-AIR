<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Open AIR Mini - Credentials</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      margin: 0;
      background: #fff;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #333;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }
    input[type="text"],
    input[type="number"],
    input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #1E90FF;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .auth-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }
    .auth-section h2 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #666;
    }
    .auth-note {
      font-size: 12px;
      color: #888;
      margin-bottom: 16px;
      font-style: italic;
    }
    .error {
      color: #d32f2f;
      padding: 10px;
      background: #ffebee;
      border-radius: 6px;
      margin-bottom: 16px;
      display: none;
    }
    .button-container {
      margin-top: 24px;
    }
    button {
      width: 100%;
      padding: 14px;
      background: #1E90FF;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #1a7fd4;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1E90FF;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1 data-i18n="pair.credentials.title">Device Configuration</h1>

  <div class="error" id="error"></div>

  <div id="form">
    <div class="form-group">
      <label for="host" data-i18n="pair.credentials.host">IP Address</label>
      <input type="text" id="host" placeholder="192.168.1.100">
      <p class="hint" data-i18n="pair.credentials.host_hint">Enter IP address only (no http://)</p>
    </div>

    <div class="form-group">
      <label for="port" data-i18n="pair.credentials.port">Port</label>
      <input type="number" id="port" value="6053" min="1" max="65535">
      <p class="hint" data-i18n="pair.credentials.port_hint">Default ESPHome API port is 6053</p>
    </div>

    <div class="auth-section">
      <h2 data-i18n="pair.credentials.auth_title">Authentication (optional)</h2>
      <p class="auth-note" data-i18n="pair.credentials.auth_note">Use encryption key for ESPHome 2023.7+ or password for older versions</p>

      <div class="form-group">
        <label for="encryptionKey" data-i18n="pair.credentials.encryption_key">Encryption Key</label>
        <input type="password" id="encryptionKey" placeholder="Base64 encoded key">
        <p class="hint" data-i18n="pair.credentials.encryption_key_hint">Found in your ESPHome YAML under api: encryption: key:</p>
      </div>

      <div class="form-group">
        <label for="password" data-i18n="pair.credentials.password">Password (legacy)</label>
        <input type="password" id="password" placeholder="API password">
        <p class="hint" data-i18n="pair.credentials.password_hint">For older ESPHome versions using api: password:</p>
      </div>
    </div>

    <div class="button-container">
      <button id="submit" type="button" disabled data-i18n="pair.credentials.connect">Connect</button>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p data-i18n="pair.credentials.connecting">Connecting to device...</p>
  </div>

  <script>
    // Homey iOS WebView compatibility:
    // In some iOS WebViews, messages arrive on `window` while homey.js listens on `document` when `?webview=1`.
    // Forward `window` message events to `document` so CrossFrame can become ready.
    (function installMessageForwarder() {
      try {
        if (getParameterByName('webview') !== '1') return;
      } catch (e) {
        // If getParameterByName isn't available yet, fall back to simple check
        if (String(location.search || '').indexOf('webview=1') === -1) return;
      }

      var forwarding = false;

      function dispatchToDocument(data) {
        if (forwarding) return;
        forwarding = true;
        try {
          var ev = new MessageEvent('message', { data: data, bubbles: false, cancelable: false });
          document.dispatchEvent(ev);
          return;
        } catch (e) {} finally {
          forwarding = false;
        }

        try {
          var legacy = document.createEvent('MessageEvent');
          legacy.initMessageEvent('message', false, false, data, '*', '', window, null);
          document.dispatchEvent(legacy);
        } catch (e) {} finally {
          forwarding = false;
        }
      }

      window.addEventListener(
        'message',
        function (e) {
          if (!e) return;
          // Prevent infinite loops if our synthetic document event is re-emitted on window.
          if (forwarding) return;

          // Only forward Homey CrossFrame messages.
          var data = e.data;
          if (typeof data !== 'string') return;
          if (data !== 'CF2_READY' && data.indexOf('CF2_MESSAGE') !== 0) return;

          dispatchToDocument(e.data);
        },
        true,
      );

    })();

    // === STATE TRACKING ===
    var scriptLoaded = false;
    var scriptError = null;
    var appStarted = false;
    var bridgeReady = false;
    var submitButton = document.getElementById('submit');

    function showFatalError(message) {
      var errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('form').style.display = 'none';
    }

    function enableForm() {
      bridgeReady = true;
      submitButton.disabled = false;
    }

    function tryStartFromGlobalHomey() {
      if (appStarted) return true;

      var Homey = window.Homey;
      if (!Homey) return false;

      var hasEmit = typeof Homey.emit === 'function';
      var hasCf = Homey._cf && typeof Homey._cf.emit === 'function';

      if (!hasEmit && !hasCf) return false;

      if (typeof Homey.ready === 'function') {
        try {
          var readyResult = Homey.ready();
          if (readyResult && typeof readyResult.then === 'function') {
            readyResult
              .then(function() {
                if (appStarted) return;
                enableForm();
                appStarted = true;
                startApp(Homey);
              })
              .catch(function() {});
            return true;
          }
        } catch (e) {}
      }

      enableForm();
      appStarted = true;
      startApp(Homey);
      return true;
    }

    // In driver pairing views, `homey.js` is typically already loaded by the `/pair/` wrapper.
    // On iOS the bridge can become available after our view HTML is injected, so poll for it.
    (function waitForHomeyBridge() {
      var attempts = 0;
      var interval = setInterval(function() {
        attempts++;

        if (tryStartFromGlobalHomey()) {
          clearInterval(interval);
          return;
        }

        if (attempts >= 60) { // ~15s
          clearInterval(interval);
          showFatalError('Unable to connect to Homey bridge. Please close and try again.');
        }
      }, 250);
    })();

    // === MAIN APP LOGIC ===
    function startApp(Homey) {
      // Helper to emit events (try official API first, fallback to _cf)
      function emit(event, data) {
        if (typeof Homey.emit === 'function') {
          return Homey.emit(event, data);
        } else if (Homey._cf && typeof Homey._cf.emit === 'function') {
          return Homey._cf.emit('emit', { event: event, data: data });
        }
        return Promise.reject(new Error('No emit'));
      }

      function createDevice(device) {
        if (typeof Homey.createDevice === 'function') {
          return new Promise(function(resolve, reject) {
            Homey.createDevice(device, function(err, result) {
              if (err) reject(err); else resolve(result);
            });
          });
        } else if (Homey._cf && typeof Homey._cf.emit === 'function') {
          return Homey._cf.emit('createDevice', device);
        }
        return Promise.reject(new Error('No createDevice'));
      }

      function done() {
        if (typeof Homey.done === 'function') {
          Homey.done();
        } else if (Homey._cf && typeof Homey._cf.send === 'function') {
          Homey._cf.send('done');
        }
      }

      var hostInput = document.getElementById('host');
      var portInput = document.getElementById('port');
      var encryptionKeyInput = document.getElementById('encryptionKey');
      var passwordInput = document.getElementById('password');
      var errorDiv = document.getElementById('error');
      var formDiv = document.getElementById('form');
      var loadingDiv = document.getElementById('loading');

      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      function hideError() {
        errorDiv.style.display = 'none';
      }

      function setLoading(loading) {
        formDiv.style.display = loading ? 'none' : 'block';
        loadingDiv.style.display = loading ? 'block' : 'none';
      }

      // Get pre-filled credentials
      emit('getCredentials', null)
        .then(function(credentials) {
          if (credentials) {
            if (credentials.host) hostInput.value = credentials.host;
            if (credentials.port) portInput.value = credentials.port;
            if (credentials.encryptionKey) encryptionKeyInput.value = credentials.encryptionKey;
            if (credentials.password) passwordInput.value = credentials.password;
          }
        })
        .catch(function() {});

      // Handle Connect button
      submitButton.addEventListener('click', function() {
        hideError();

        var host = hostInput.value.trim().replace(/^https?:\/\//i, '');
        var port = parseInt(portInput.value, 10) || 6053;
        var encryptionKey = encryptionKeyInput.value.trim();
        var password = passwordInput.value.trim();

        if (!host) {
          showError(Homey.__('pair.credentials.error_host_required') || 'IP address is required');
          return;
        }

        setLoading(true);

        emit('setCredentials', {
          host: host,
          port: port,
          encryptionKey: encryptionKey || null,
          password: password || null
        })
          .then(function() {
            return emit('createDevice', null);
          })
          .then(function(device) {
            return createDevice(device);
          })
          .then(function() {
            done();
          })
          .catch(function(err) {
            setLoading(false);
            showError(err.message || Homey.__('pair.credentials.error_connection') || 'Failed to connect');
          });
      });

      // Enter key submits
      [hostInput, portInput, encryptionKeyInput, passwordInput].forEach(function(input) {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !submitButton.disabled) submitButton.click();
        });
      });
    }
  </script>
</body>
</html>
